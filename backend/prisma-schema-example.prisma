// schema.prisma - Exemplo de como ficaria

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================
// MODELS
// ========================================

model User {
  id             BigInt         @id @default(autoincrement()) @db.UnsignedBigInt
  fullName       String         @map("full_name") @db.VarChar(150)
  email          String         @unique @db.VarChar(150)
  passwordHash   String         @map("password_hash") @db.VarChar(255)
  role           Role           @default(professor)
  subject        String?        @db.VarChar(120)
  school         String?        @db.VarChar(150)
  phone          String?        @db.VarChar(30)
  cpf            String?        @db.VarChar(20)
  firebaseUid    String?        @unique @map("firebase_uid") @db.VarChar(191)
  profilePicture String?        @map("profile_picture") @db.VarChar(500)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relacionamentos
  classrooms     Classroom[]
  students       Student[]
  teacherClasses TeacherClass[]

  @@map("users")
}

model Classroom {
  id            BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  ownerUserId   BigInt?      @map("owner_user_id") @db.UnsignedBigInt
  name          String       @db.VarChar(120)
  turma         String?      @db.VarChar(120)
  periodo       String?      @db.VarChar(60)
  totalStudents Int          @default(0) @map("total_students")
  createdAt     DateTime     @default(now()) @map("created_at")

  // Relacionamentos
  owner         User?        @relation(fields: [ownerUserId], references: [id])
  students      Student[]
  attendanceLogs AttendanceLog[]
  enrollments   Enrollment[]

  @@index([ownerUserId], map: "idx_classrooms_owner")
  @@map("classrooms")
}

model Student {
  id           BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  nome         String       @db.VarChar(150)
  matricula    String?      @db.VarChar(100)
  email        String?      @db.VarChar(150)
  telefone     String?      @db.VarChar(30)
  classroomId  BigInt?      @map("classroom_id") @db.UnsignedBigInt
  ownerUserId  BigInt?      @map("owner_user_id") @db.UnsignedBigInt
  foto         String?      @db.VarChar(500)
  ativo        Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")

  // Relacionamentos
  classroom    Classroom?   @relation(fields: [classroomId], references: [id], onDelete: SetNull)
  owner        User?        @relation(fields: [ownerUserId], references: [id])
  attendanceLogs AttendanceLog[]
  enrollments  Enrollment[]

  @@index([ownerUserId], map: "idx_students_owner")
  @@index([classroomId], map: "idx_students_classroom")
  @@index([ativo, foto], map: "idx_students_active_foto")
  @@index([matricula], map: "idx_students_matricula")
  @@map("students")
}

model AttendanceLog {
  id          BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  studentId   BigInt     @map("student_id") @db.UnsignedBigInt
  classroomId BigInt?    @map("classroom_id") @db.UnsignedBigInt
  capturedAt  DateTime   @default(now()) @map("captured_at")
  confidence  Float?     @db.Float
  deviceLabel String?    @map("device_label") @db.VarChar(100)
  metadata    Json?

  // Relacionamentos
  student     Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroom   Classroom? @relation(fields: [classroomId], references: [id], onDelete: SetNull)

  @@index([studentId, capturedAt], map: "idx_attendance_student_time")
  @@index([classroomId], map: "idx_attendance_classroom")
  @@index([capturedAt], map: "idx_attendance_captured")
  @@map("attendance_logs")
}

model TeacherClass {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  className String   @map("class_name") @db.VarChar(120)
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, className], map: "uq_teacher_class")
  @@index([userId], map: "idx_teacher_classes_user")
  @@map("teacher_classes")
}

model Enrollment {
  id          BigInt      @id @default(autoincrement()) @db.UnsignedBigInt
  studentId   BigInt      @map("student_id") @db.UnsignedBigInt
  classroomId BigInt      @map("classroom_id") @db.UnsignedBigInt
  enrolledAt  DateTime    @default(now()) @map("enrolled_at")
  status      EnrollmentStatus @default(active)

  // Relacionamentos
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroom   Classroom   @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([studentId, classroomId], map: "uq_enrollment")
  @@index([studentId], map: "idx_enrollment_student")
  @@index([classroomId], map: "idx_enrollment_classroom")
  @@map("enrollments")
}

// ========================================
// ENUMS
// ========================================

enum Role {
  admin
  professor
}

enum EnrollmentStatus {
  active
  inactive
  transferred
}
